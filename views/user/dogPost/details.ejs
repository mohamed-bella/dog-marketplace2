<!DOCTYPE html>
<html lang="fr">
<head>
    <%- include('../include/head') %>
    <title><%= pageTitle %></title>
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="<%= post.name %> - <%= post.type === 'adoption' ? 'Adoption' : 'Chien perdu' %>">
    <meta property="og:description" content="<%= post.description %>">
    <% if (post.photo && post.photo.length > 0) { %>
    <meta property="og:image" content="<%= post.photo %>">
    <% } %>
</head>
<body class="bg-gray-50">
    <%- include('../include/navbar') %>

    <main class="container mx-auto px-4 py-8">
        <!-- Breadcrumb -->
        <nav class="mb-8">
            <ol class="flex items-center space-x-2 text-sm text-gray-500">
                <li>
                    <a href="/" class="hover:text-primary-500">Accueil</a>
                </li>
                <li><i class="fas fa-chevron-right text-xs"></i></li>
                <li>
                    <a href="/posts" class="hover:text-primary-500">Annonces</a>
                </li>
                <li><i class="fas fa-chevron-right text-xs"></i></li>
                <li class="text-gray-900 font-medium"><%= post.name %></li>
            </ol>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Status Banner -->
                <% if (post.status === 'resolved') { %>
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-3"></i>
                            <p class="text-green-700">
                                <%= post.type === 'adoption' ? 'Ce chien a été adopté' : 'Ce chien a été retrouvé' %>
                            </p>
                        </div>
                    </div>
                <% } %>

                <!-- Image Gallery -->
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <% if (post.photo && post.photo.length > 0) { %>
                        <div class="relative">
                            <!-- Main Image -->
                            <img 
                                src="<%= post.photo %>" 
                                alt="<%= post.name %>"
                                class="w-full h-[400px] object-cover"
                                id="mainImage"
                            >
                            
                            <!-- Type Badge -->
                            <div class="absolute top-4 left-4">
                                <span class="px-4 py-2 rounded-full text-sm font-medium <%= post.type === 'adoption' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
                                    <%= post.type === 'adoption' ? 'Adoption' : 'Perdu' %>
                                </span>
                            </div>

                            <!-- Share Button -->
                            <button 
                                onclick="sharePost()"
                                class="absolute top-4 right-4 p-2 bg-white/90 rounded-full hover:bg-white transition-colors">
                                <i class="fas fa-share-alt text-gray-600"></i>
                            </button>
                        </div>

                        <!-- Thumbnails -->
                       
                    <% } else { %>
                        <div class="h-[400px] bg-gray-100 flex items-center justify-center">
                            <i class="fas fa-dog text-6xl text-gray-300"></i>
                        </div>
                    <% } %>
                </div>

                <!-- Dog Information -->
                <div class="bg-white rounded-2xl shadow-sm p-6 space-y-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h1 class="text-2xl font-semibold text-gray-900 mb-2"><%= post.name %></h1>
                            <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                                <% if (post.breed) { %>
                                    <span class="flex items-center">
                                        <i class="fas fa-paw mr-2"></i>
                                        <%= post.breed %>
                                    </span>
                                <% } %>
                                <span class="flex items-center">
                                    <i class="fas fa-map-marker-alt mr-2"></i>
                                    <%= post.location %>
                                </span>
                                <span class="flex items-center">
                                    <i class="fas fa-clock mr-2"></i>
                                    <%= new Date(post.createdAt).toLocaleDateString('fr-FR') %>
                                </span>
                                <% if (post.age) { %>
                                    <span class="flex items-center">
                                        <i class="fas fa-birthday-cake mr-2"></i>
                                        <%= post.age %> an<%= post.age > 1 ? 's' : '' %>
                                    </span>
                                <% } %>
                            </div>
                        </div>
                    </div>

                    <% if (post.description) { %>
                        <div class="prose max-w-none">
                            <p class="text-gray-600"><%= post.description %></p>
                        </div>
                    <% } %>

                    <!-- Additional Information -->
                    <% if (post.additionalInfo) { %>
                        <div class="border-t border-gray-100 pt-6">
                            <h2 class="text-lg font-semibold text-gray-900 mb-4">Informations supplémentaires</h2>
                            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <% Object.entries(post.additionalInfo).forEach(([key, value]) => { %>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <dt class="text-sm font-medium text-gray-500"><%= key %></dt>
                                        <dd class="mt-1 text-sm text-gray-900"><%= value %></dd>
                                    </div>
                                <% }) %>
                            </dl>
                        </div>
                    <% } %>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Contact Card -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Contact</h2>
                    <div class="space-y-4">
                        <% if (post.contactInfo.phone) { %>
                            <a href="tel:<%= post.contactInfo.phone %>"
                               class="flex items-center justify-center w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">
                                <i class="fas fa-phone mr-2"></i>
                                Appeler
                            </a>
                        <% } %>
                        
                        <% if (post.contactInfo.email) { %>
                            <a href="mailto:<%= post.contactInfo.email %>"
                               class="flex items-center justify-center w-full px-4 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                <i class="fas fa-envelope mr-2"></i>
                                Envoyer un email
                            </a>
                        <% } %>

                        <!-- WhatsApp -->
                        <% if (post.contactInfo.phone) { %>
                            <a href="https://wa.me/<%= post.contactInfo.phone.replace(/[^0-9]/g, '') %>"
                               target="_blank"
                               class="flex items-center justify-center w-full px-4 py-3 bg-[#25D366] text-white rounded-lg hover:bg-[#22c55e] transition-colors">
                                <i class="fab fa-whatsapp mr-2"></i>
                                WhatsApp
                            </a>
                        <% } %>
                    </div>
                </div>

                <!-- Location Map -->
                <% if (post.coordinates) { %>
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Localisation</h2>
                        <div class="aspect-w-16 aspect-h-9 rounded-lg overflow-hidden">
                            <!-- Add your map implementation here -->
                            <div id="map" class="w-full h-full"></div>
                        </div>
                    </div>
                <% } %>

                <!-- Related Posts -->
                <% if (relatedPosts && relatedPosts.length > 0) { %>
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4">Annonces similaires</h2>
                        <div class="space-y-4">
                            <% relatedPosts.forEach(relatedPost => { %>
                                <a href="/posts/<%= relatedPost._id %>" 
                                   class="block p-4 border border-gray-100 rounded-xl hover:border-primary-500 transition-colors">
                                    <div class="flex gap-4">
                                        <div class="w-20 h-20 rounded-lg overflow-hidden flex-shrink-0">
                                            <% if (relatedPost.photo && relatedPost.photo.length > 0) { %>
                                                <img 
                                                    src="<%= relatedPost.photo %>" 
                                                    alt="<%= relatedPost.name %>"
                                                    class="w-full h-full object-cover"
                                                >
                                            <% } else { %>
                                                <div class="w-full h-full bg-gray-100 flex items-center justify-center">
                                                    <i class="fas fa-dog text-2xl text-gray-300"></i>
                                                </div>
                                            <% } %>
                                        </div>
                                        <div>
                                            <h3 class="font-medium text-gray-900"><%= relatedPost.name %></h3>
                                            <p class="text-sm text-gray-500 mt-1"><%= relatedPost.location %></p>
                                        </div>
                                    </div>
                                </a>
                            <% }) %>
                        </div>
                    </div>
                <% } %>
            </div>
        </div>
    </main>

    <script>
        // Image Gallery
        function changeMainImage(url, button) {
            document.getElementById('mainImage').src = url;
            
            // Update active thumbnail
            document.querySelectorAll('.thumbnail-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-primary-500');
            });
            button.classList.add('ring-2', 'ring-primary-500');
        }

        // Share Functionality
        function sharePost() {
            const shareData = {
                title: '<%= post.name %>',
                text: '<%= post.type === "adoption" ? "Chien à adopter" : "Chien perdu" %>: <%= post.name %>',
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData)
                    .catch(error => console.log('Error sharing:', error));
            } else {
                // Fallback: copy to clipboard
                navigator.clipboard.writeText(window.location.href)
                    .then(() => showToast('Lien copié !'))
                    .catch(error => console.error('Error copying link:', error));
            }
        }

        // Toast Notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg
                             transform transition-all duration-300 translate-y-0 opacity-100`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('translate-y-2', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        // Track Contact Clicks
        function trackContact(type) {
            fetch('/api/track-contact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    postId: '<%= post._id %>',
                    contactType: type,
                    timestamp: new Date().toISOString()
                })
            }).catch(console.error);
        }

        // Initialize Map if coordinates exist
        <% if (post.coordinates) { %>
        function initMap() {
            const map = L.map('map').setView([
                <%= post.coordinates.lat %>, 
                <%= post.coordinates.lng %>
            ], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            L.marker([
                <%= post.coordinates.lat %>, 
                <%= post.coordinates.lng %>
            ]).addTo(map)
              .bindPopup('<%= post.location %>');
        }

        // Load map after page load
        document.addEventListener('DOMContentLoaded', initMap);
        <% } %>

        // Image Lightbox
        const images = document.querySelectorAll('.thumbnail-btn img');
        let currentImageIndex = 0;

        function createLightbox(startIndex) {
            const lightbox = document.createElement('div');
            lightbox.className = 'fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center';
            lightbox.innerHTML = `
                <button class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300" onclick="closeLightbox()">
                    <i class="fas fa-times"></i>
                </button>
                <button class="absolute left-4 top-1/2 -translate-y-1/2 text-white text-3xl hover:text-gray-300" onclick="prevImage()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="absolute right-4 top-1/2 -translate-y-1/2 text-white text-3xl hover:text-gray-300" onclick="nextImage()">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="relative max-w-4xl max-h-[80vh]">
                    <img src="${images[startIndex].src}" class="max-w-full max-h-[80vh] object-contain" id="lightboxImage">
                    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white text-sm">
                        ${startIndex + 1} / ${images.length}
                    </div>
                </div>
            `;
            document.body.appendChild(lightbox);
            document.body.style.overflow = 'hidden';
            currentImageIndex = startIndex;
        }

        function closeLightbox() {
            const lightbox = document.querySelector('.fixed.bg-black');
            if (lightbox) {
                lightbox.remove();
                document.body.style.overflow = 'auto';
            }
        }

        function nextImage() {
            currentImageIndex = (currentImageIndex + 1) % images.length;
            updateLightboxImage();
        }

        function prevImage() {
            currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
            updateLightboxImage();
        }

        function updateLightboxImage() {
            const lightboxImage = document.getElementById('lightboxImage');
            if (lightboxImage) {
                lightboxImage.src = images[currentImageIndex].src;
                const counter = lightboxImage.parentElement.querySelector('.text-white.text-sm');
                counter.textContent = `${currentImageIndex + 1} / ${images.length}`;
            }
        }

        // Add click listeners to thumbnails
        images.forEach((img, index) => {
            img.addEventListener('click', () => createLightbox(index));
        });

        // Keyboard navigation for lightbox
        document.addEventListener('keydown', (e) => {
            const lightbox = document.querySelector('.fixed.bg-black');
            if (lightbox) {
                if (e.key === 'Escape') closeLightbox();
                if (e.key === 'ArrowRight') nextImage();
                if (e.key === 'ArrowLeft') prevImage();
            }
        });

        // Report Modal
        function openReportModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Signaler l'annonce</h3>
                    <form id="reportForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Raison du signalement
                            </label>
                            <select required class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl">
                                <option value="">Sélectionnez une raison</option>
                                <option value="fake">Annonce frauduleuse</option>
                                <option value="inappropriate">Contenu inapproprié</option>
                                <option value="expired">Annonce expirée</option>
                                <option value="other">Autre raison</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Description
                            </label>
                            <textarea 
                                required
                                class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl h-32"
                                placeholder="Décrivez le problème..."
                            ></textarea>
                        </div>
                        <div class="flex justify-end gap-3">
                            <button 
                                type="button"
                                onclick="this.closest('.fixed').remove()"
                                class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                Annuler
                            </button>
                            <button 
                                type="submit"
                                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                Signaler
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);

            // Handle form submission
            document.getElementById('reportForm').addEventListener('submit', handleReport);
        }

        // Handle report submission
        async function handleReport(e) {
            e.preventDefault();
            const form = e.target;
            const reason = form.querySelector('select').value;
            const description = form.querySelector('textarea').value;

            try {
                const response = await fetch('/api/report-post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        postId: '<%= post._id %>',
                        reason,
                        description
                    })
                });

                if (response.ok) {
                    showToast('Merci pour votre signalement');
                    form.closest('.fixed').remove();
                } else {
                    throw new Error('Failed to submit report');
                }
            } catch (error) {
                showToast('Une erreur est survenue');
                console.error('Error submitting report:', error);
            }
        }

        // Print functionality
        function printPost() {
            window.print();
        }

        // Add to favorites
        async function toggleFavorite() {
            try {
                const response = await fetch('/api/toggle-favorite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        postId: '<%= post._id %>'
                    })
                });

                if (response.ok) {
                    const { isFavorite } = await response.json();
                    const favBtn = document.getElementById('favBtn');
                    favBtn.innerHTML = isFavorite ? 
                        '<i class="fas fa-heart text-red-500"></i>' :
                        '<i class="far fa-heart"></i>';
                    showToast(isFavorite ? 'Ajouté aux favoris' : 'Retiré des favoris');
                }
            } catch (error) {
                console.error('Error toggling favorite:', error);
                showToast('Une erreur est survenue');
            }
        }
    </script>

    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
        }

        /* Image zoom effect */
        .thumbnail-btn img {
            transition: transform 0.2s;
        }
        .thumbnail-btn:hover img {
            transform: scale(1.1);
        }

        /* Custom scrollbar for the page */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>

    <% if (post.coordinates) { %>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <% } %>
</body>
</html>