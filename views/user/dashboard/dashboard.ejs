<%- include('includes/head.ejs') %>
     <%- include('includes/navbar.ejs') %>
          <%- include('includes/content.ejs') %>

               <!-- Add Announcement Modal -->
               <div class="modal fade" id="announcementModal" tabindex="-1" aria-labelledby="announcementModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                         <div class="modal-content">
                              <div class="modal-header bg-primary text-white">
                                   <h5 class="modal-title" id="announcementModalLabel">Ajouter une Nouvelle Annonce</h5>
                                   <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
                              </div>
                              <div class="modal-body">
                                   <div class="step-indicator mb-4">
                                        <div class="step active" data-step="1">1</div>
                                        <div class="step" data-step="2">2</div>
                                        <div class="step" data-step="3">3</div>
                                        <div class="step" data-step="4">4</div>
                                        <div class="step" data-step="5">5</div>
                                   </div>
                                   <form id="announcementForm" action="/announcements/new" method="POST" enctype="multipart/form-data">
                                        <!-- Step 1: Type d'Annonce et Informations de Base -->
                                        <div class="form-step" data-step="1">
                                             <h4 class="mb-4">Que voulez-vous faire ?</h4>
                                             <div class="option-grid">
                                                  <label class="option-card">
                                                       <input type="radio" name="announcementType" value="sale" required>
                                                       <div class="option-content">
                                                            <img src="https://img.icons8.com/ios-filled/50/000000/sell.png" alt="Vendre" class="mb-2" style="width: 50px;">
                                                            <span>Vendre</span>
                                                       </div>
                                                  </label>
                                                  <label class="option-card">
                                                       <input type="radio" name="announcementType" value="adoption" required>
                                                       <div class="option-content">
                                                            <img src="https://img.icons8.com/ios-filled/50/000000/pet-home.png" alt="Adoption" class="mb-2" style="width: 50px;">
                                                            <span>Adoption</span>
                                                       </div>
                                                  </label>
                                             </div>
                                             <div class="mt-4">
                                                  <h5>Type d'Animal</h5>
                                                  <div class="option-grid">
                                                       <label class="option-card">
                                                            <input type="radio" name="animalType" value="dog" required>
                                                            <div class="option-content">
                                                                 <img src="https://img.icons8.com/ios-filled/50/000000/dog.png" alt="Chien" class="mb-2" style="width: 50px;">
                                                                 <span>Chien</span>
                                                            </div>
                                                       </label>
                                                       <label class="option-card">
                                                            <input type="radio" name="animalType" value="cat" required>
                                                            <div class="option-content">
                                                                 <img src="https://img.icons8.com/ios-filled/50/000000/cat.png" alt="Chat" class="mb-2" style="width: 50px;">
                                                                 <span>Chat</span>
                                                            </div>
                                                       </label>
                                                  </div>
                                             </div>
                                             <div class="form-floating mt-4">
                                                  <input type="text" class="form-control" id="breed" name="breed" required>
                                                  <label for="breed">Race</label>
                                             </div>
                                        </div>

                                        <!-- Step 2: Détails de l'Animal -->
                                        <div class="form-step" data-step="2" style="display: none;">
                                             <h4 class="mb-4">Détails de l'Animal</h4>
                                             <div class="mb-3">
                                                  <label class="form-label">Âge*</label>
                                                  <div class="option-grid">
                                                       <label class="option-card">
                                                            <input type="radio" name="age" value="puppy" required>
                                                            <div class="option-content">
                                                                 <img src="https://img.icons8.com/ios-filled/20/000000/dog.png" alt="Chien" class="mb-2" style="width: 20px;">
                                                                 <span>Chiot/Chaton</span>
                                                            </div>
                                                       </label>
                                                       <label class="option-card">
                                                            <input type="radio" name="age" value="adult">
                                                            <div class="option-content">
                                                                 <img src="https://img.icons8.com/ios-filled/40/000000/dog.png" alt="Chien" class="mb-2" style="width: 40px;">
                                                                 <span>Adulte</span>
                                                            </div>
                                                       </label>
                                                       <label class="option-card">
                                                            <input type="radio" name="age" value="senior">
                                                            <div class="option-content">
                                                                 <img src="https://img.icons8.com/ios-filled/60/000000/dog.png" alt="Chien" class="mb-2" style="width: 60px;">
                                                                 <span>chien Age</span>
                                                            </div>
                                                       </label>
                                                  </div>
                                             </div>
                                             <div class="mb-3">
                                                  <label class="form-label">Sexe*</label>
                                                  <div class="option-grid">
                                                       <label class="option-card">
                                                            <input type="radio" name="gender" value="male" required>
                                                            <div class="option-content">
                                                                 <img src="https://img.icons8.com/ios-filled/50/000000/male.png" alt="Mâle" class="mb-2" style="width: 50px;">
                                                                 <span>Mâle</span>
                                                            </div>
                                                       </label>
                                                       <label class="option-card">
                                                            <input type="radio" name="gender" value="female">
                                                            <div class="option-content">
                                                                 <img src="https://img.icons8.com/ios-filled/50/000000/female.png" alt="Femelle" class="mb-2" style="width: 50px;">
                                                                 <span>Femelle</span>
                                                            </div>
                                                       </label>
                                                  </div>
                                             </div>
                                             <!-- </div> -->
                                             <div class="mb-3">
                                                  <label class="form-label">Statut de Vaccination*</label>
                                                  <div class="option-grid">
                                                       <label class="option-card">
                                                            <input type="radio" name="vaccination" value="yes" required>
                                                            <div class="option-content">
                                                                 <i class="fas fa-syringe fa-2x mb-2"></i>
                                                                 <span>Vacciné</span>
                                                            </div>
                                                       </label>
                                                       <label class="option-card">
                                                            <input type="radio" name="vaccination" value="no">
                                                            <div class="option-content">
                                                                 <i class="fas fa-times-circle fa-2x mb-2"></i>
                                                                 <span>Non Vacciné</span>
                                                            </div>
                                                       </label>
                                                       <label class="option-card">
                                                            <input type="radio" name="vaccination" value="unknown">
                                                            <div class="option-content">
                                                                 <i class="fas fa-question-circle fa-2x mb-2"></i>
                                                                 <span>Inconnu</span>
                                                            </div>
                                                       </label>
                                                  </div>
                                             </div>
                                             <div class="mb-3">
                                                  <label class="form-label">Statut de Stérilisation*</label>
                                                  <div class="option-grid">
                                                       <label class="option-card">
                                                            <input type="radio" name="sterilization" value="yes" required>
                                                            <div class="option-content">
                                                                 <i class="fas fa-check-circle fa-2x mb-2"></i>
                                                                 <span>Stérilisé</span>
                                                            </div>
                                                       </label>
                                                       <label class="option-card">
                                                            <input type="radio" name="sterilization" value="no">
                                                            <div class="option-content">
                                                                 <i class="fas fa-times-circle fa-2x mb-2"></i>
                                                                 <span>Non Stérilisé</span>
                                                            </div>
                                                       </label>
                                                       <label class="option-card">
                                                            <input type="radio" name="sterilization" value="unknown">
                                                            <div class="option-content">
                                                                 <i class="fas fa-question-circle fa-2x mb-2"></i>
                                                                 <span>Inconnu</span>
                                                            </div>
                                                       </label>
                                                  </div>
                                             </div>
                                        </div>

                                        <!-- Step 3: Prix et Localisation -->
                                        <div class="form-step" data-step="3" style="display: none;">
                                             <h4 class="mb-4">Prix et Localisation</h4>
                                             <div class="mb-3" id="priceField">
                                                  <label for="price" class="form-label">Prix (MAD)*</label>
                                                  <input type="number" class="form-control" id="price" name="price" min="0" required>
                                             </div>
                                             <div class="mb-3" id="adoptionFeeField" style="display: none;">
                                                  <label for="adoptionFee" class="form-label">Frais d'Adoption (MAD)</label>
                                                  <input type="number" class="form-control" id="adoptionFee" name="adoptionFee" min="0">
                                             </div>
                                             <div class="mb-3">
                                                  <label for="location" class="form-label">Localisation*</label>
                                                  <select class="form-select" id="location" name="location" required>
                                                       <option value="" selected disabled>Choisissez une ville</option>
                                                       <option value="casablanca">Casablanca</option>
                                                       <option value="rabat">Rabat</option>
                                                       <option value="marrakech">Marrakech</option>
                                                       <option value="fes">Fès</option>
                                                       <option value="tanger">Tanger</option>
                                                       <!-- Add other cities here -->
                                                  </select>
                                             </div>
                                        </div>

                                        <!-- Step 4: Informations de Contact et Description -->
                                        <div class="form-step" data-step="4" style="display: none;">
                                             <h4 class="mb-4">Contact et Description</h4>
                                             <div class="form-floating mb-3">
                                                  <input type="tel" class="form-control" id="whatsapp" name="whatsapp" required>
                                                  <label for="whatsapp">Numéro WhatsApp*</label>
                                             </div>

                                             <div class="form-floating mb-3">
                                                  <textarea class="form-control" id="description" name="description" style="height: 100px" required></textarea>
                                                  <label for="description">Description*</label>
                                             </div>
                                        </div>

                                        <!-- Step 5: Téléchargement d'Images -->
                                        <div class="form-step" data-step="5" style="display: none;">
                                             <h4 class="mb-4">Télécharger des Images</h4>
                                             <div class="mb-3">
                                                  <label for="images" class="form-label">Télécharger des Images*</label>
                                                  <input class="form-control" type="file" id="images" name="images" multiple accept="image/*" required>
                                             </div>
                                             <div id="imagePreview" class="mb-3 d-flex flex-wrap gap-2"></div>
                                        </div>

                                        <div class="d-flex justify-content-between mt-4">
                                             <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">Précédent</button>
                                             <button type="button" class="btn btn-primary" id="nextBtn">Suivant</button>
                                             <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">Soumettre</button>
                                        </div>
                                   </form>
                              </div>
                         </div>
                    </div>
               </div>

               <style>
                    .step-indicator {
                         display: flex;
                         justify-content: space-between;
                         margin-bottom: 2rem;
                    }

                    .step {
                         width: 30px;
                         height: 30px;
                         border-radius: 50%;
                         background-color: #e0e0e0;
                         display: flex;
                         align-items: center;
                         justify-content: center;
                         font-weight: bold;
                    }

                    .step.active {
                         background-color: #007bff;
                         color: white;
                    }

                    .option-grid {
                         display: grid;
                         grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                         gap: 1rem;
                    }

                    .option-card {
                         border: 2px solid #e0e0e0;
                         border-radius: 8px;
                         /* padding: 1rem; */
                         text-align: center;
                         cursor: pointer;
                         transition: all 0.3s ease;
                    }

                    .option-card:hover {
                         border-color: #007bff;
                    }

                    .option-card input[type="radio"] {
                         display: none;
                    }

                    .option-card input[type="radio"]:checked+.option-content {
                         background-color: #e6f2ff;
                         border-color: #007bff;
                    }

                    .option-content {
                         display: flex;
                         padding: 1em;
                         justify-content: center;
                         align-items: center;

                         flex-direction: column;
                         align-items: center;
                    }

                    .form-floating {
                         margin-bottom: 1rem;
                    }

                    @media (max-width: 768px) {
                         .option-grid {
                              grid-template-columns: 1fr 1fr;
                         }
                    }
               </style>

               <script>
                    document.addEventListener('DOMContentLoaded', function () {
                         const form = document.getElementById('announcementForm');
                         const steps = form.querySelectorAll('.form-step');
                         const stepIndicators = document.querySelectorAll('.step-indicator .step');
                         const prevBtn = document.getElementById('prevBtn');
                         const nextBtn = document.getElementById('nextBtn');
                         const submitBtn = document.getElementById('submitBtn');
                         let currentStep = 0;

                         function showStep(stepIndex) {
                              steps.forEach((step, index) => {
                                   step.style.display = index === stepIndex ? 'block' : 'none';
                              });
                              updateStepIndicator(stepIndex);
                              updateButtons();
                         }

                         function updateStepIndicator(stepIndex) {
                              stepIndicators.forEach((indicator, index) => {
                                   if (index === stepIndex) {
                                        indicator.classList.add('active');
                                   } else {
                                        indicator.classList.remove('active');
                                   }
                              });
                         }

                         function updateButtons() {
                              prevBtn.style.display = currentStep > 0 ? 'block' : 'none';
                              nextBtn.style.display = currentStep < steps.length - 1 ? 'block' : 'none';
                              submitBtn.style.display = currentStep === steps.length - 1 ? 'block' : 'none';
                         }

                         nextBtn.addEventListener('click', () => {
                              if (validateStep(currentStep)) {
                                   if (currentStep < steps.length - 1) {
                                        currentStep++;
                                        showStep(currentStep);
                                   }
                              }
                         });

                         prevBtn.addEventListener('click', () => {
                              if (currentStep > 0) {
                                   currentStep--;
                                   showStep(currentStep);
                              }
                         });

                         function validateStep(stepIndex) {
                              const currentStepElement = steps[stepIndex];
                              const inputs = currentStepElement.querySelectorAll('input[required], select[required], textarea[required]');
                              let isValid = true;

                              inputs.forEach(input => {
                                   if (input.type === 'radio') {
                                        const radioGroup = currentStepElement.querySelectorAll(`input[name="${input.name}"]`);
                                        const isChecked = Array.from(radioGroup).some(radio => radio.checked);
                                        if (!isChecked) {
                                             isValid = false;
                                             input.closest('.option-grid').classList.add('is-invalid');
                                        } else {
                                             input.closest('.option-grid').classList.remove('is-invalid');
                                        }
                                   } else if (!input.value.trim()) {
                                        isValid = false;
                                        input.classList.add('is-invalid');
                                   } else {
                                        input.classList.remove('is-invalid');
                                   }
                              });

                              return isValid;
                         }

                         const announcementType = document.getElementById('announcementType');
                         const priceField = document.getElementById('priceField');
                         const adoptionFeeField = document.getElementById('adoptionFeeField');

                         document.querySelectorAll('input[name="announcementType"]').forEach(input => {
                              input.addEventListener('change', function () {
                                   if (this.value === 'adoption') {
                                        priceField.style.display = 'none';
                                        adoptionFeeField.style.display = 'block';
                                        document.getElementById('price').removeAttribute('required');
                                        document.getElementById('adoptionFee').setAttribute('required', 'required');
                                   } else {
                                        priceField.style.display = 'block';
                                        adoptionFeeField.style.display = 'none';
                                        document.getElementById('price').setAttribute('required', 'required');
                                        document.getElementById('adoptionFee').removeAttribute('required');
                                   }
                              });
                         });

                         const imageInput = document.getElementById('images');
                         const imagePreview = document.getElementById('imagePreview');

                         imageInput.addEventListener('change', function () {
                              imagePreview.innerHTML = '';
                              for (let i = 0; i < this.files.length; i++) {
                                   const file = this.files[i];
                                   if (file.type.startsWith('image/')) {
                                        const img = document.createElement('img');
                                        img.classList.add('img-thumbnail');
                                        img.style.width = '100px';
                                        img.style.height = '100px';
                                        img.style.objectFit = 'cover';
                                        img.file = file;
                                        imagePreview.appendChild(img);

                                        const reader = new FileReader();
                                        reader.onload = (function (aImg) {
                                             return function (e) {
                                                  aImg.src = e.target.result;
                                             };
                                        })(img);
                                        reader.readAsDataURL(file);
                                   }
                              }
                         });

                         form.addEventListener('submit', function (e) {
                              e.preventDefault();

                              if (!validateStep(currentStep)) {
                                   return;
                              }

                              submitBtn.disabled = true;
                              submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Envoi en cours...`;

                              const formData = new FormData(form);

                              fetch('/announcements/new', {
                                   method: 'POST',
                                   body: formData
                              })
                                   .then(response => response.json())
                                   .then(data => {
                                        if (data.success) {
                                             window.location.href = '/dashboard';
                                        } else {
                                             alert('Une erreur est survenue lors de la soumission de votre annonce.');
                                        }
                                   })
                                   .catch(error => {
                                        console.error('Erreur lors de la soumission du formulaire:', error);
                                        alert('Une erreur est survenue. Veuillez réessayer.');
                                   })
                                   .finally(() => {
                                        submitBtn.disabled = false;
                                        submitBtn.innerHTML = 'Soumettre';
                                   });
                         });

                         showStep(currentStep);
                    });
               </script>

               <%- include('includes/footer.ejs') %>