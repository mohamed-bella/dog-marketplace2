<!-- Include necessary CSS and JS libraries (e.g., Tailwind CSS, jQuery) -->
<%- include('includes/head') %>
     <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
     <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">


     <div class="container mx-auto mt-10">
          <h2 class="text-2xl font-bold mb-4">Broadcast Email</h2>

          <!-- Subject and Message Fields -->
          <div class="mb-6">
               <label for="subject" class="block font-semibold">Subject</label>
               <input type="text" id="subject" class="w-full p-2 border border-gray-300 rounded mt-1" required>
          </div>
          <div class="mb-6">
               <label for="message" class="block font-semibold">Message</label>
               <textarea id="message" rows="6" class="w-full p-2 border border-gray-300 rounded mt-1"></textarea>
          </div>

          <!-- Users Selection -->
          <div class="mb-6">
               <div class="flex items-center mb-2">
                    <input type="checkbox" id="select-all" class="mr-2">
                    <label for="select-all" class="font-semibold">Select All Users</label>
               </div>
               <div id="users-list" class="max-h-64 overflow-y-auto border border-gray-200 rounded p-2">
                    <% users.forEach(user=> { %>
                         <div class="flex items-center mb-2">
                              <input type="checkbox" class="user-checkbox mr-2" value="<%= user.email %>" id="user-<%= user._id %>">
                              <label for="user-<%= user._id %>" class="text-gray-700">
                                   <%= user.email %>
                              </label>
                         </div>
                         <% }); %>
               </div>
          </div>

          <!-- Send Button -->
          <button id="send-button" class="px-6 py-2 bg-blue-600 text-white rounded flex items-center" disabled>
               <span id="button-text">Send Broadcast</span>
               <svg id="loading-spinner" class="animate-spin h-5 w-5 ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
               </svg>
          </button>

          <!-- Status Messages -->
          <div id="status-messages" class="mt-6 space-y-2"></div>
     </div>

     <!-- Include jQuery -->
     <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

     <script>
          // Enable the send button when subject and message are filled
          function checkFormValidity() {
               const subject = $('#subject').val().trim();
               const message = $('#message').val().trim();
               const anyUserSelected = $('.user-checkbox:checked').length > 0;
               $('#send-button').prop('disabled', !(subject && message && anyUserSelected));
          }

          $(document).ready(function () {
               // Check all users
               $('#select-all').change(function () {
                    $('.user-checkbox').prop('checked', $(this).is(':checked'));
                    checkFormValidity();
               });

               // Uncheck 'Select All' if any checkbox is unchecked
               $('.user-checkbox').change(function () {
                    if (!$(this).is(':checked')) {
                         $('#select-all').prop('checked', false);
                    }
                    // Check 'Select All' if all checkboxes are checked
                    else if ($('.user-checkbox:checked').length === $('.user-checkbox').length) {
                         $('#select-all').prop('checked', true);
                    }
                    checkFormValidity();
               });

               // Enable/disable send button on input change
               $('#subject, #message').on('input', checkFormValidity);

               // Handle form submission
               $('#send-button').click(function () {
                    const subject = $('#subject').val().trim();
                    const message = $('#message').val().trim();
                    const emails = $('.user-checkbox:checked').map(function () { return this.value; }).get();

                    if (!subject || !message || emails.length === 0) {
                         alert('Please fill in all fields and select at least one user.');
                         return;
                    }

                    // Disable the button and show loading spinner
                    $(this).prop('disabled', true);
                    $('#loading-spinner').removeClass('hidden');
                    $('#button-text').text('Sending...');

                    // Send emails via AJAX
                    sendEmails(emails, subject, message);
               });
          });

          function sendEmails(emails, subject, message) {
               let index = 0;

               function sendNextEmail() {
                    if (index >= emails.length) {
                         $('#loading-spinner').addClass('hidden');
                         $('#button-text').text('Send Broadcast');
                         $('#send-button').prop('disabled', false);
                         $('#status-messages').append('<div class="text-green-600 font-semibold">All emails have been sent.</div>');
                         return;
                    }

                    const email = emails[index];
                    $.ajax({
                         url: '/admin/send-email',
                         method: 'POST',
                         data: { email, subject, message },
                         success: function (response) {
                              $('#status-messages').append(`<div class="text-green-600">Email sent to ${email}</div>`);
                         },
                         error: function (xhr, status, error) {
                              $('#status-messages').append(`<div class="text-red-600">Failed to send email to ${email}</div>`);
                         },
                         complete: function () {
                              index++;
                              setTimeout(sendNextEmail, 500); // Delay of 500ms between emails
                         }
                    });
               }

               sendNextEmail();
          }
     </script>