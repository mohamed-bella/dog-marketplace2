<!DOCTYPE html>
<html lang="ar">

<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>تحليل سلالات الكلاب</title>
     <script src="https://cdn.tailwindcss.com"></script>
     <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<%- include('include/head.ejs', { user }) %>
     <%- include('include/navbar.ejs', { user }) %>

          <body class="min-h-screen bg-gray-50 p-4">
               <div class="max-w-4xl mx-auto text-right">
                    <div class="text-center mb-8">
                         <h1 class="text-3xl font-bold text-blue-600">تحليل سلالات الكلاب</h1>
                         <p class="text-gray-600">قم بتحميل صورة لتحليل سلالة الكلب وخصائصها</p>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                         <div id="dropArea" class="border-2 border-dashed border-blue-500 rounded-xl p-8 text-center mb-6">
                              <div class="space-y-4">
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                   </svg>
                                   <div class="text-gray-600">
                                        اسحب الصورة هنا أو
                                        <label class="text-blue-600 hover:text-blue-700 cursor-pointer">
                                             <span>تصفح</span>
                                             <input type="file" id="fileInput" class="hidden" accept="image/*">
                                        </label>
                                   </div>
                              </div>
                         </div>

                         <div id="previewArea" class="hidden">
                              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                   <div>
                                        <h3 class="text-lg font-semibold mb-3">معاينة الصورة</h3>
                                        <img id="preview" class="w-full rounded-lg border">
                                   </div>
                                   <div>
                                        <h3 class="text-lg font-semibold mb-3">نتائج التحليل</h3>
                                        <div id="results" class="space-y-2"></div>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>

               <script>
                    document.addEventListener("DOMContentLoaded", () => {
                         const dropArea = document.getElementById('dropArea');
                         const fileInput = document.getElementById('fileInput');
                         const preview = document.getElementById('preview');
                         const previewArea = document.getElementById('previewArea');
                         const resultsDiv = document.getElementById('results');

                         // Event listeners for file upload and drop area
                         ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(event => {
                              dropArea.addEventListener(event, (e) => e.preventDefault());
                         });
                         dropArea.addEventListener('drop', handleFileSelect);
                         fileInput.addEventListener('change', handleFileSelect);

                         function handleFileSelect(e) {
                              const file = e.target.files ? e.target.files[0] : e.dataTransfer.files[0];
                              if (file && file.type.startsWith('image/')) {
                                   preview.src = URL.createObjectURL(file);
                                   previewArea.classList.remove('hidden');
                                   analyzeDogBreed(file);
                              }
                         }

                         // AJAX function to send the image for analysis
                         async function analyzeDogBreed(file) {
                              const formData = new FormData();
                              formData.append('image', file);

                              Swal.fire({
                                   title: 'جارٍ التحليل...',
                                   text: 'يرجى الانتظار بينما يتم معالجة الصورة',
                                   allowOutsideClick: false,
                                   didOpen: () => Swal.showLoading()
                              });

                              try {
                                   const response = await fetch('/analyze-breed', {
                                        method: 'POST',
                                        body: formData
                                   });

                                   const results = await response.json();
                                   Swal.close();
                                   displayResults(results);
                              } catch (error) {
                                   Swal.fire('خطأ', 'حدث خطأ أثناء تحليل الصورة', 'error');
                              }
                         }

                         // Displaying the analysis results
                         function displayResults(results) {
                              resultsDiv.innerHTML = '';
                              results.forEach(result => {
                                   const resultElement = document.createElement('div');
                                   resultElement.className = 'p-3 rounded-lg border border-gray-300 mb-2';
                                   resultElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-medium">${result.label}</span>
                            <span class="font-bold text-blue-600">${(result.score * 100).toFixed(1)}%</span>
                        </div>
                    `;
                                   resultsDiv.appendChild(resultElement);
                              });
                         }
                    });
               </script>
          </body>

</html>