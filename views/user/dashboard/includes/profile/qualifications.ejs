<!-- includes/profile/qualifications.ejs -->

<div class="bg-white rounded-2xl shadow-sm" id="qualificationsSection">
     <!-- Header -->
     <div class="p-6 border-b border-gray-100">
          <div class="flex items-center justify-between">
               <h3 class="text-lg font-semibold text-gray-800">Votre Diplomes :</h3>
               <button type="button" id="addQualificationBtn" class="text-sm px-3 py-1.5 rounded-lg text-blue-600 hover:bg-blue-50 transition-colors">
                    <i class="fas fa-plus mr-1.5"></i>
                    <span>Ajouter</span>
               </button>
          </div>
     </div>

     <!-- List of Qualifications -->
     <div class="p-6" id="qualificationsList">
          <% if (user.qualifications && user.qualifications.length> 0) { %>
               <ul class="space-y-4">
                    <% user.qualifications.forEach(qualification=> { %>
                         <li class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                              <div>
                                   <h4 class="text-md font-semibold">
                                        <%= qualification.title %>
                                   </h4>
                                   <p class="text-sm text-gray-600">
                                        <%= qualification.institution %> - <%= qualification.year %>
                                   </p>
                              </div>
                              <div class="flex items-center space-x-3">
                                   <% if (qualification.certificate) { %>
                                        <a href="<%= qualification.certificate %>" target="_blank" class="text-blue-600 hover:underline">
                                             Voir le certificat
                                        </a>
                                        <% } %>
                                             <button type="button" class="deleteQualificationBtn text-red-600 hover:underline" data-id="<%= qualification._id %>">
                                                  Supprimer
                                             </button>
                              </div>
                         </li>
                         <% }); %>
               </ul>
               <% } else { %>
                    <p class="text-gray-500 italic">Aucune qualification ajoutée.</p>
                    <% } %>
     </div>

     <!-- Add Qualification Form -->
     <form id="addQualificationForm" class="p-6 hidden" enctype="multipart/form-data">
          <div class="space-y-6">
               <!-- Title -->
               <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-1">
                         Titre <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="title" name="title" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
               </div>

               <!-- Institution -->
               <div>
                    <label for="institution" class="block text-sm font-medium text-gray-700 mb-1">
                         Institution <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="institution" name="institution" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
               </div>

               <!-- Year -->
               <div>
                    <label for="year" class="block text-sm font-medium text-gray-700 mb-1">
                         Année <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="year" name="year" min="1900" max="<%= new Date().getFullYear() %>" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
               </div>

               <!-- Certificate -->
               <div>
                    <label for="certificate" class="block text-sm font-medium text-gray-700 mb-1">
                         Certificat (optionnel)
                    </label>
                    <input type="file" id="certificate" name="certificate" accept="image/*" class="w-full">
               </div>

               <!-- Action Buttons -->
               <div class="flex gap-3 pt-4 border-t">
                    <button type="button" id="cancelAddQualificationBtn" class="flex-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                         Annuler
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                         Enregistrer
                    </button>
               </div>
          </div>
     </form>
</div>

<!-- Qualifications Script -->
<script>
     document.addEventListener('DOMContentLoaded', function () {
          const $addQualificationBtn = document.getElementById('addQualificationBtn');
          const $addQualificationForm = document.getElementById('addQualificationForm');
          const $qualificationsList = document.getElementById('qualificationsList');
          const $cancelAddQualificationBtn = document.getElementById('cancelAddQualificationBtn');

          // Toggle Add Qualification Form
          function toggleAddQualificationForm() {
               $addQualificationForm.classList.toggle('hidden');
               $qualificationsList.classList.toggle('hidden');
               $addQualificationBtn.classList.toggle('hidden');
          }

          $addQualificationBtn.addEventListener('click', toggleAddQualificationForm);
          $cancelAddQualificationBtn.addEventListener('click', toggleAddQualificationForm);

          // Handle Add Qualification Form Submission
          $addQualificationForm.addEventListener('submit', async function (e) {
               e.preventDefault();

               const $submitBtn = this.querySelector('button[type="submit"]');
               $submitBtn.disabled = true;

               try {
                    // Get form data
                    const formData = new FormData(this);

                    // Send request
                    const response = await fetch('/dashboard/profile/qualifications', {
                         method: 'POST',
                         body: formData
                    });

                    const result = await response.json();

                    if (response.ok) {
                         window.location.reload();
                    } else {
                         throw new Error(result.message);
                    }
               } catch (error) {
                    Swal.fire({
                         icon: 'error',
                         title: 'Erreur',
                         text: error.message || 'Une erreur est survenue lors de l\'ajout'
                    });
                    $submitBtn.disabled = false;
               }
          });

          // Handle Delete Qualification
          document.querySelectorAll('.deleteQualificationBtn').forEach(button => {
               button.addEventListener('click', async function () {
                    const qualificationId = this.dataset.id;

                    const confirmation = await Swal.fire({
                         title: 'Êtes-vous sûr ?',
                         text: 'Cette action est irréversible.',
                         icon: 'warning',
                         showCancelButton: true,
                         confirmButtonText: 'Oui, supprimer',
                         cancelButtonText: 'Annuler'
                    });

                    if (confirmation.isConfirmed) {
                         try {
                              const response = await fetch(`/dashboard/profile/qualifications/${qualificationId}`, {
                                   method: 'DELETE'
                              });

                              const result = await response.json();

                              if (response.ok) {
                                   window.location.reload();
                              } else {
                                   throw new Error(result.message);
                              }
                         } catch (error) {
                              Swal.fire({
                                   icon: 'error',
                                   title: 'Erreur',
                                   text: error.message || 'Une erreur est survenue lors de la suppression'
                              });
                         }
                    }
               });
          });
     });
</script>