<%- include('include/head.ejs') %>
     <%- include('include/navbar.ejs') %>

          <main class="min-h-screen bg-gray-50">
               <!-- Hero Section with Search -->
               <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-16">
                    <div class="container mx-auto px-4">
                         <div class="max-w-3xl mx-auto text-center">
                              <h1 class="text-4xl md:text-5xl font-bold mb-6">
                                   Trouvez votre prestataire idéal
                              </h1>
                              <p class="text-xl text-blue-100 mb-8">
                                   Des professionnels qualifiés et vérifiés pour prendre soin de vos animaux
                              </p>
                         </div>
                    </div>
               </div>

               <!-- Main Content -->
               <div class="container mx-auto px-4 -mt-8">
                    <!-- Filters Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                         <form id="filterForm" class="space-y-6">
                              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                   <!-- Location Filter -->
                                   <div class="space-y-2">
                                        <label class="text-sm font-semibold text-gray-700">
                                             <i class="fas fa-map-marker-alt mr-2 text-blue-600"></i>Ville
                                        </label>
                                        <select name="location" class="w-full rounded-lg border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                                             <option value="">Toutes les villes</option>
                                             <% locations.forEach(location=> { %>
                                                  <option value="<%= location %>" <%=filters.location===location ? 'selected' : '' %>>
                                                       <%= location.charAt(0).toUpperCase() + location.slice(1) %>
                                                  </option>
                                                  <% }) %>
                                        </select>
                                   </div>

                                   <!-- Specialization Filter -->
                                   <div class="space-y-2">
                                        <label class="text-sm font-semibold text-gray-700">
                                             <i class="fas fa-briefcase mr-2 text-blue-600"></i>Spécialisation
                                        </label>
                                        <select name="specialization" class="w-full rounded-lg border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                                             <option value="">Toutes les spécialisations</option>
                                             <% specializations.forEach(spec=> { %>
                                                  <option value="<%= spec %>" <%=filters.specialization===spec ? 'selected' : '' %>>
                                                       <%= spec.split('-').map(word=> word.charAt(0).toUpperCase() + word.slice(1)).join(' ') %>
                                                  </option>
                                                  <% }) %>
                                        </select>
                                   </div>

                                   <!-- Rating Filter -->
                                   <div class="space-y-2">
                                        <label class="text-sm font-semibold text-gray-700">
                                             <i class="fas fa-star mr-2 text-blue-600"></i>Note minimum
                                        </label>
                                        <select name="rating" class="w-full rounded-lg border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                                             <option value="">Toutes les notes</option>
                                             <% [4.5, 4, 3.5, 3].forEach(rating=> { %>
                                                  <option value="<%= rating %>" <%=filters.rating===String(rating) ? 'selected' : '' %>>
                                                       <%= rating %>+ étoiles
                                                  </option>
                                                  <% }) %>
                                        </select>
                                   </div>

                                   <!-- Sort Filter -->
                                   <div class="space-y-2">
                                        <label class="text-sm font-semibold text-gray-700">
                                             <i class="fas fa-sort mr-2 text-blue-600"></i>Trier par
                                        </label>
                                        <select name="sort" class="w-full rounded-lg border-gray-200 focus:ring-blue-500 focus:border-blue-500 shadow-sm">
                                             <option value="score" <%=filters.sort==='score' ? 'selected' : '' %>>Score NDRESSILIK</option>
                                             <option value="rating" <%=filters.sort==='rating' ? 'selected' : '' %>>Note</option>
                                             <option value="reviews" <%=filters.sort==='reviews' ? 'selected' : '' %>>Nombre d'avis</option>
                                             <option value="experience" <%=filters.sort==='experience' ? 'selected' : '' %>>Expérience</option>
                                        </select>
                                   </div>
                              </div>
                         </form>
                    </div>

                    <!-- Results Summary -->
                    <div class="flex items-center justify-between mb-8">
                         <div class="text-lg text-gray-600">
                              <strong>
                                   <%= totalProviders %>
                              </strong> prestataire<%= totalProviders> 1 ? 's' : '' %> trouvé<%= totalProviders> 1 ? 's' : '' %>
                         </div>
                    </div>

                    <!-- Providers Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                         <% providers.forEach(provider=> { %>
                              <article class="bg-white rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden group">
                                   <!-- Cover Image -->
                                   <div class="relative h-48 overflow-hidden">
                                        <img src="<%= provider.coverImage %>" alt="<%= provider.displayName %>" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">

                                        <!-- Profile Image -->
                                        <div class="absolute -bottom-6 left-6">
                                             <div class="relative">
                                                  <img src="<%= provider.profileImage %>" alt="<%= provider.displayName %>" class="w-20 h-20 rounded-xl border-4 border-white shadow-md">
                                                  <% if (provider.isVerified) { %>
                                                       <div class="absolute -top-2 -right-2 bg-blue-600 text-white p-1.5 rounded-full shadow-lg">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                            </svg>
                                                       </div>
                                                       <% } %>
                                             </div>
                                        </div>
                                   </div>

                                   <!-- Provider Info -->
                                   <div class="p-6 pt-10">
                                        <div class="mb-4">
                                             <h3 class="text-xl font-bold text-gray-900 mb-2">
                                                  <%= provider.displayName %>
                                             </h3>
                                             <p class="text-gray-600 flex items-center">
                                                  <i class="fas fa-map-marker-alt text-blue-600 mr-2"></i>
                                                  <%= provider.location?.city %>
                                             </p>
                                        </div>

                                        <!-- Specializations -->
                                        <div class="flex flex-wrap gap-2 mb-6">
                                             <% provider.specializations.slice(0, 3).forEach(spec=> { %>
                                                  <span class="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm font-medium">
                                                       <%= spec.split('-').map(word=> word.charAt(0).toUpperCase() + word.slice(1)).join(' ') %>
                                                  </span>
                                                  <% }) %>
                                                       <% if (provider.specializations.length> 3) { %>
                                                            <span class="px-3 py-1 bg-gray-50 text-gray-600 rounded-full text-sm font-medium">
                                                                 +<%= provider.specializations.length - 3 %>
                                                            </span>
                                                            <% } %>
                                        </div>

                                        <!-- Stats -->
                                        <div class="grid grid-cols-3 gap-4 py-4 border-t border-gray-100">
                                             <div class="text-center">
                                                  <div class="flex items-center justify-center gap-1 text-lg font-bold text-gray-900">
                                                       <%= provider.metrics.averageRating?.toFixed(1) || '0.0' %>
                                                            <i class="fas fa-star text-yellow-400 text-sm"></i>
                                                  </div>
                                                  <div class="text-sm text-gray-500">Note</div>
                                             </div>
                                             <div class="text-center">
                                                  <div class="text-lg font-bold text-gray-900">
                                                       <%= provider.metrics.totalServices || 0 %>
                                                  </div>
                                                  <div class="text-sm text-gray-500">Services</div>
                                             </div>
                                             <div class="text-center">
                                                  <div class="text-lg font-bold text-gray-900">
                                                       <%= provider.metrics.totalReviews || 0 %>
                                                  </div>
                                                  <div class="text-sm text-gray-500">Avis</div>
                                             </div>
                                        </div>

                                        <!-- Action Button -->
                                        <a href="/@<%= provider.slug %>" class="block w-full text-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors mt-6 font-semibold">
                                             Voir le profil
                                        </a>
                                   </div>
                              </article>
                              <% }) %>
                    </div>

                    <!-- Pagination -->
                    <% if (totalPages> 1) { %>
                         <div class="flex justify-center mt-12 mb-8">
                              <div class="inline-flex rounded-lg shadow-sm">
                                   <% for (let i=1; i <=totalPages; i++) { %>
                                        <a href="?page=<%= i %>&<%= new URLSearchParams({...filters, page: undefined}).toString() %>" class="px-5 py-3 <%= currentPage === i ? 'bg-blue-600 text-white font-semibold' : 'bg-white text-gray-700 hover:bg-gray-50' %> <%= i === 1 ? 'rounded-l-lg' : '' %> <%= i === totalPages ? 'rounded-r-lg' : '' %> border <%= i !== 1 ? 'border-l-0' : '' %>">
                                             <%= i %>
                                        </a>
                                        <% } %>
                              </div>
                         </div>
                         <% } %>
               </div>
          </main>

          <script>
               // Enhanced filter form handling with debounce
               const filterForm = document.getElementById('filterForm');
               const selects = filterForm.querySelectorAll('select');

               let timeout;
               selects.forEach(select => {
                    select.addEventListener('change', () => {
                         clearTimeout(timeout);
                         timeout = setTimeout(() => {
                              filterForm.submit();
                         }, 300);
                    });
               });
          </script>

          <%- include('include/footer.ejs') %>