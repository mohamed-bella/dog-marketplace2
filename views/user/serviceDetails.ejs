<%- include('include/head.ejs') %>
     <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@5.3.7/dist/photoswipe.css">

     <%- include('include/navbar.ejs') %>
          <!-- Immersive Hero Section -->
          <div class="relative min-h-[60vh] bg-gradient-to-b from-[#001d3d] to-[#003566]">
               <!-- Dynamic Background Pattern -->
               <div class="absolute inset-0 opacity-10">
                    <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cpath d=\'M54.627 4.383a9.23 9.23 0 0 1-.324 1.462 9.207 9.207 0 0 1-.566 1.368 9.29 9.29 0 0 1-.794 1.247 9.290 9.290 0 0 1-2.426 1.604\' fill=\'none\' stroke=\'%23fff\' stroke-width=\'2\' stroke-linecap=\'round\' stroke-linejoin=\'round\'/%3E%3C/svg%3E');"></div>
               </div>

               <!-- Main Hero Content -->
               <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-12">
                    <div class="flex flex-col lg:flex-row items-start gap-12">
                         <!-- Left: Service Info -->
                         <div class="flex-1 text-white">
                              <!-- Service Type Badge -->
                              <div class="inline-flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full mb-6">
                                   <span class="text-2xl">
                                        <%= service.serviceOptions==='dressage' ? '🐕' : service.serviceOptions==='toilettage' ? '✂️' : service.serviceOptions==='pension' ? '🏠' : '' %>
                                   </span>
                                   <span class="text-sm font-medium">
                                        <%= service.serviceOptions %>
                                   </span>
                              </div>

                              <!-- Title & Description -->
                              <h1 class="text-4xl lg:text-5xl font-bold mb-6 leading-tight">
                                   <%= service.serviceName %>
                              </h1>
                              <p class="text-xl text-white/80 mb-8 leading-relaxed max-w-2xl">
                                   <%= service.description %>
                              </p>

                              <!-- Quick Info Pills -->
                              <div class="flex flex-wrap gap-4 mb-8">
                                   <div class="flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>
                                             <%= service.location || 'Location non spécifiée' %>
                                        </span>
                                   </div>
                                   <div class="flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full">
                                        <i class="fas fa-eye"></i>
                                        <span>
                                             <%= service.views %> vues
                                        </span>
                                   </div>
                                   <div class="flex items-center gap-2 bg-[#ffd60a] px-4 py-2 rounded-full text-[#001d3d]">
                                        <i class="fas fa-tag"></i>
                                        <span class="font-semibold">
                                             <%= service.priceRange + ' DH' || 'Sur devis' %>
                                        </span>
                                   </div>
                              </div>
                         </div>

                         <!-- Right: Provider Card -->
                         <div class="lg:w-96 w-full">
                              <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                                   <div class="p-6">
                                        <!-- Provider Header -->
                                        <div class="flex items-center gap-4 mb-6">
                                             <img src="<%= service.createdBy.profileImage || '/default-avatar.png' %>" alt="<%= service.createdBy.displayName %>" class="w-16 h-16 rounded-full object-cover ring-4 ring-[#ffd60a]/20">
                                             <div>
                                                  <a href="/@<%= service.createdBy.slug %>" class="text-lg font-bold text-gray-900">
                                                       <%= service.createdBy.displayName %>
                                                            <% if(service.createdBy.isVerified) { %>
                                                                 <i class="fas fa-check-circle text-[#003566] ml-1"></i>
                                                                 <% } %>
                                                  </a>
                                                  <p class="text-gray-500">Prestataire Professionnel</p>
                                             </div>
                                        </div>

                                        <!-- Contact Options -->
                                        <div class="space-y-4">
                                             <a href="tel:<%= service.serviceNumber %>" class="flex items-center gap-3 p-4 rounded-xl bg-[#003566] text-white hover:bg-[#002851] 
                                      transition-colors group">
                                                  <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                                                       <i class="fas fa-phone-alt"></i>
                                                  </div>
                                                  <span class="flex-1">
                                                       <%= service.serviceNumber || 'Numéro non disponible' %>
                                                  </span>
                                                  <i class="fas fa-arrow-right opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                             </a>
                                             <% if ( service.createdBy.email) { %>
                                                  <a href="mailto:<%= service.createdBy.email %>" class="flex items-center gap-3 p-4 rounded-xl bg-gray-100 text-gray-900 hover:bg-gray-200 
                                                                                        transition-colors group">
                                                       <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                                                            <i class="fas fa-envelope"></i>
                                                       </div>
                                                       <span class="flex-1 truncate">
                                                            <%= service.createdBy.email %>
                                                       </span>
                                                       <i class="fas fa-arrow-right opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                                  </a>
                                                  <% } %>

                                        </div>

                                        <!-- Share Button -->
                                        <button onclick="shareService()" class="mt-4 w-full flex items-center justify-center gap-2 p-4 rounded-xl border-2 
                                       border-gray-200 text-gray-700 hover:bg-gray-50 transition-colors">
                                             <i class="fas fa-share-alt"></i>
                                             <span>Partager ce service</span>
                                        </button>
                                        <!-- Share Modal -->
                                        <div id="shareModal" class="fixed inset-0 z-50 bg-[#001d3d]/98 opacity-0 pointer-events-none transition-opacity duration-300">
                                             <div class="min-h-screen px-4 text-center">
                                                  <!-- Background overlay -->
                                                  <div class="fixed inset-0" aria-hidden="true"></div>

                                                  <!-- Modal container -->
                                                  <div class="inline-block w-full max-w-md p-6 my-8 text-left align-middle transition-all transform bg-white 
                                                            rounded-2xl shadow-xl relative">
                                                       <div class="absolute top-4 right-4">
                                                            <button onclick="closeShareModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition-colors">
                                                                 <i class="fas fa-times text-gray-500"></i>
                                                            </button>
                                                       </div>

                                                       <!-- Modal content -->
                                                       <div class="mt-4">
                                                            <div class="flex items-center gap-3 mb-6">
                                                                 <div class="w-10 h-10 rounded-full bg-[#001d3d]/10 flex items-center justify-center">
                                                                      <i class="fas fa-share-alt text-[#001d3d]"></i>
                                                                 </div>
                                                                 <div>
                                                                      <h3 class="text-lg font-bold text-gray-900">Partager ce service</h3>
                                                                      <p class="text-sm text-gray-500">Choisissez comment partager</p>
                                                                 </div>
                                                            </div>

                                                            <!-- Share options -->
                                                            <div class="grid grid-cols-2 gap-4 mb-6">
                                                                 <button onclick="shareViaWhatsApp()" class="flex items-center gap-3 p-4 rounded-xl hover:bg-green-50 transition-colors group">
                                                                      <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                                                           <i class="fab fa-whatsapp text-green-500"></i>
                                                                      </div>
                                                                      <span class="text-sm font-medium text-gray-700 group-hover:text-green-600">WhatsApp</span>
                                                                 </button>

                                                                 <button onclick="shareViaFacebook()" class="flex items-center gap-3 p-4 rounded-xl hover:bg-blue-50 transition-colors group">
                                                                      <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                                                                           <i class="fab fa-facebook text-blue-500"></i>
                                                                      </div>
                                                                      <span class="text-sm font-medium text-gray-700 group-hover:text-blue-600">Facebook</span>
                                                                 </button>
                                                            </div>

                                                            <!-- Copy link section -->
                                                            <div class="relative">
                                                                 <input type="text" id="shareLink" value="<%= `https://ndressilik.com/service/${service._id}` %>" class="w-full px-4 py-3 pr-24 rounded-xl border border-gray-200 text-sm focus:outline-none 
                                                                       focus:border-[#003566] focus:ring-2 focus:ring-[#003566]/20" readonly>
                                                                 <button onclick="copyShareLink()" class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-1.5 bg-[#001d3d] text-white 
                                                                       rounded-lg text-sm hover:bg-[#003566] transition-colors">
                                                                      Copier
                                                                 </button>
                                                            </div>
                                                       </div>
                                                  </div>
                                             </div>
                                        </div>

                                        <script>
                                             function shareService() {
                                                  // Check if native share is available
                                                  if (navigator.share) {
                                                       navigator.share({
                                                            title: '<%= service.serviceName %>',
                                                            text: '<%= service.description %>',
                                                            url: window.location.href
                                                       })
                                                            .then(() => console.log('Shared successfully'))
                                                            .catch((error) => {
                                                                 console.log('Error sharing:', error);
                                                                 openShareModal();
                                                            });
                                                  } else {
                                                       openShareModal();
                                                  }
                                             }

                                             function openShareModal() {
                                                  const modal = document.getElementById('shareModal');
                                                  modal.classList.add('opacity-100', 'pointer-events-auto');
                                                  document.body.style.overflow = 'hidden';
                                             }

                                             function closeShareModal() {
                                                  const modal = document.getElementById('shareModal');
                                                  modal.classList.remove('opacity-100', 'pointer-events-auto');
                                                  document.body.style.overflow = '';
                                             }

                                             function shareViaWhatsApp() {
                                                  const text = `Découvrez ${service.serviceName} sur NDRESSILIK:\n${window.location.href}`;
                                                  const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
                                                  window.open(whatsappUrl, '_blank');
                                             }

                                             function shareViaFacebook() {
                                                  const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}`;
                                                  window.open(facebookUrl, '_blank');
                                             }

                                             function copyShareLink() {
                                                  const shareLink = document.getElementById('shareLink');
                                                  shareLink.select();
                                                  shareLink.setSelectionRange(0, 99999); // For mobile devices

                                                  navigator.clipboard.writeText(shareLink.value)
                                                       .then(() => {
                                                            // Show success toast
                                                            const toast = document.createElement('div');
                                                            toast.className = `fixed bottom-4 right-4 bg-[#001d3d] text-white px-6 py-3 rounded-xl 
                                                                     shadow-lg flex items-center gap-2 transform translate-y-full opacity-0 
                                                                     transition-all duration-300`;
                                                            toast.innerHTML = `
                                                        <i class="fas fa-check-circle"></i>
                                                        <span>Lien copié!</span>
                                                    `;

                                                            document.body.appendChild(toast);

                                                            // Animate toast
                                                            setTimeout(() => {
                                                                 toast.classList.remove('translate-y-full', 'opacity-0');
                                                            }, 100);

                                                            // Remove toast
                                                            setTimeout(() => {
                                                                 toast.classList.add('translate-y-full', 'opacity-0');
                                                                 setTimeout(() => toast.remove(), 300);
                                                            }, 3000);
                                                       })
                                                       .catch(err => {
                                                            console.error('Failed to copy text: ', err);
                                                       });
                                             }

                                             // Close modal on escape key
                                             document.addEventListener('keydown', (e) => {
                                                  if (e.key === 'Escape') {
                                                       closeShareModal();
                                                  }
                                             });
                                        </script>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>

          </div>





          <!-- Gallery Section -->
          <div class="relative bg-gray-50 -mt-8 pt-20 pb-16">
               <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <!-- Gallery Header -->
                    <div class="flex items-center justify-between mb-8">
                         <div class="inline-flex items-center gap-2 bg-[#001d3d]/10 backdrop-blur-sm px-4 py-2 rounded-full">
                              <i class="fas fa-images text-[#001d3d]"></i>
                              <span class="text-sm font-medium text-[#001d3d]">Photos du service</span>
                         </div>

                    </div>

                    <!-- Main Gallery Grid -->
                    <div class="grid grid-cols-4 gap-4 aspect-[16/9]" id="gallery">
                         <% let images=Array.isArray(service.images) ? service.images : JSON.parse(service.images); %>
                              <% images.slice(0, -1).forEach((image, index)=> { %>
                                   <div class="<%= index === 0 ? 'col-span-2 row-span-2' : '' %> 
                                      relative group overflow-hidden rounded-2xl cursor-pointer" onclick="openLightbox(<%= index %>)">
                                        <img src="<%= image %>" alt="<%= service.serviceName %> - Image <%= index + 1 %>" class="w-full h-full object-cover transition-transform duration-500 
                                         group-hover:scale-110">
                                        <!-- Hover Overlay -->
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent 
                                          opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                             <div class="absolute bottom-4 left-4 text-white flex items-center gap-2">
                                                  <i class="fas fa-expand-alt"></i>
                                                  <span class="text-sm font-medium">Agrandir</span>
                                             </div>
                                        </div>
                                   </div>
                                   <% }) %>
                    </div>
               </div>
          </div>



          <script>
               // Gallery functions
               function openGalleryModal() {
                    const modal = document.getElementById('galleryModal');
                    modal.classList.add('opacity-100', 'pointer-events-auto');
                    document.body.style.overflow = 'hidden';
               }

               function closeGalleryModal() {
                    const modal = document.getElementById('galleryModal');
                    modal.classList.remove('opacity-100', 'pointer-events-auto');
                    document.body.style.overflow = '';
               }

               // Initialize PhotoSwipe
               const lightbox = new PhotoSwipeLightbox({
                    gallery: '#gallery, #galleryModal',
                    children: 'img',
                    pswpModule: PhotoSwipe,
                    padding: { top: 20, bottom: 20 },
                    bgOpacity: 0.95,
                    showHideOpacity: true,
                    imageClickAction: 'zoom',
                    tapAction: 'toggle-controls',
               });

               lightbox.init();

               // Handle escape key
               document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                         closeGalleryModal();
                    }
               });

               // Handle image loading
               document.addEventListener('DOMContentLoaded', () => {
                    const images = document.querySelectorAll('img');
                    images.forEach(img => {
                         if (img.complete) {
                              img.classList.add('loaded');
                         } else {
                              img.addEventListener('load', () => img.classList.add('loaded'));
                         }
                    });
               });
          </script>

          <style>
               /* Image loading animation */
               img {

                    transition: opacity 0.3s ease-in-out;
               }

               img.loaded {
                    opacity: 1;
               }

               /* Custom scrollbar */
               .overflow-y-auto {
                    scrollbar-width: thin;
                    scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
               }

               .overflow-y-auto::-webkit-scrollbar {
                    width: 6px;
               }

               .overflow-y-auto::-webkit-scrollbar-track {
                    background: transparent;
               }

               .overflow-y-auto::-webkit-scrollbar-thumb {
                    background-color: rgba(255, 255, 255, 0.2);
                    border-radius: 3px;
               }
          </style>