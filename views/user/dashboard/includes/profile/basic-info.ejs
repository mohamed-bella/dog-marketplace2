<!-- Section Header -->
<% const cities=[ { arabic: 'الدار البيضاء' , french: 'Casablanca' }, { arabic: 'الرباط' , french: 'Rabat' }, { arabic: 'مراكش' , french: 'Marrakech' }, { arabic: 'أكادير' , french: 'Agadir' }, { arabic: 'طنجة' , french: 'Tanger' }, { arabic: 'فاس' , french: 'Fès' }, { arabic: 'مكناس' , french: 'Meknès' }, { arabic: 'وجدة' , french: 'Oujda' }, { arabic: 'القنيطرة' , french: 'Kénitra' }, { arabic: 'تطوان' , french: 'Tétouan' }, { arabic: 'آسفي' , french: 'Safi' }, { arabic: 'الجديدة' , french: 'El Jadida' }, { arabic: 'الناظور' , french: 'Nador' }, { arabic: 'برشيد' , french: 'Berrechid' }, { arabic: 'الخميسات' , french: 'Khemisset' }, { arabic: 'خريبكة' , french: 'Khouribga' }, { arabic: 'سطات' , french: 'Settat' }, { arabic: 'العرائش' , french: 'Larache' }, { arabic: 'بني ملال' , french: 'Beni Mellal' }, { arabic: 'كلميم' , french: 'Guelmim' }, { arabic: 'تازة' , french: 'Taza' }, { arabic: 'سيدي قاسم' , french: 'Sidi Kacem' }, { arabic: 'تزنيت' , french: 'Tiznit' }, { arabic: 'الصويرة' , french: 'Essaouira' }, { arabic: 'خنيفرة' , french: 'Khenifra' }, { arabic: 'طانطان' , french: 'Tan-Tan' }, { arabic: 'جرسيف' , french: 'Guercif' }, { arabic: 'شفشاون' , french: 'Chefchaouen' }, { arabic: 'المحمدية' , french: 'Mohammedia' }, { arabic: 'تاونات' , french: 'Taounate' }, { arabic: 'سيدي سليمان' , french: 'Sidi Slimane' }, { arabic: 'طرفاية' , french: 'Tarfaya' }, { arabic: 'ميدلت' , french: 'Midelt' }, { arabic: 'الرشيدية' , french: 'Errachidia' }, { arabic: 'أزرو' , french: 'Azrou' }, { arabic: 'بن جرير' , french: 'Ben Guerir' }, { arabic: 'شيشاوة' , french: 'Chichaoua' }, { arabic: 'ورزازات' , french: 'Ouarzazate' }, { arabic: 'زايو' , french: 'Zaio' } ]; %>
     <% const languageOptions=['french', 'arabic' , 'english' , 'spanish' ]; %>


          <div class="bg-white rounded-2xl shadow-lg overflow-hidden" id="basicInfoSection" dir="rtl">
               <!-- Enhanced Header -->
               <div class="p-6 border-b border-gray-100 relative bg-gradient-to-r from-blue-500/5 to-blue-600/5">
                    <div class="absolute inset-x-0 bottom-0 h-1 bg-gradient-to-r from-blue-500 to-blue-600"></div>
                    <div class="flex items-center justify-between">
                         <div class="flex items-center gap-4">
                              <h3 class="text-xl font-bold text-gray-800 font-arabic">المعلومات الأساسية</h3>
                              <div class="relative group">
                                   <span class="flex h-8 w-8 items-center justify-center rounded-full bg-blue-50 text-blue-600 
                                cursor-help transition-transform duration-300 group-hover:scale-110">
                                        <i class="fas fa-info-circle"></i>
                                   </span>
                                   <div class="absolute right-0 bottom-full mb-2 hidden group-hover:block w-72 p-4 
                                bg-gray-900 text-white text-sm rounded-xl shadow-xl z-10 
                                transform transition-all duration-300 font-arabic">
                                        <div class="flex items-start gap-3">
                                             <i class="fas fa-lightbulb text-yellow-400 mt-1"></i>
                                             <p>هذه المعلومات ستكون مرئية في ملفك الشخصي العام وستساعد العملاء على معرفتك بشكل أفضل.</p>
                                        </div>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>

               <!-- Form Section -->
               <form id="basicInfoForm" class="p-6 space-y-8">
                    <!-- Personal Info Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <!-- Name Input -->
                         <div class="space-y-3">
                              <label for="displayName" class="block text-base font-semibold text-gray-700 font-arabic">
                                   الإسم الكامل <span class="text-blue-500">*</span>
                              </label>
                              <div class="relative group">
                                   <input type="text" id="displayName" name="displayName" value="<%= user.displayName %>" class="w-full h-12 pr-12 pl-4 bg-gray-50 border-2 border-gray-200 rounded-xl
                                  text-right font-arabic
                                  focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10
                                  transition-all duration-300" required>
                                   <i class="fas fa-user absolute right-4 top-1/2 -translate-y-1/2 text-gray-400
                             group-focus-within:text-blue-500 transition-colors"></i>
                              </div>
                         </div>

                         <!-- Phone Input -->
                         <div class="space-y-3">
                              <label for="phoneNumber" class="block text-base font-semibold text-gray-700 font-arabic">
                                   رقم الهاتف <span class="text-blue-500">*</span>
                              </label>
                              <div class="relative group">
                                   <input type="tel" id="phoneNumber" name="phoneNumber" value="<%= user.phoneNumber %>" class="w-full h-12 pr-12 pl-4 bg-gray-50 border-2 border-gray-200 rounded-xl
                                  text-right font-arabic
                                  focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10
                                  transition-all duration-300" pattern="^(?:\+212|0)[567]\d{8}$" required>
                                   <i class="fas fa-phone absolute right-4 top-1/2 -translate-y-1/2 text-gray-400
                             group-focus-within:text-blue-500 transition-colors"></i>
                              </div>
                              <p class="text-sm text-gray-500 font-arabic">تنسيق: +212 أو 06/07</p>
                         </div>

                         <!-- City Select -->
                         <div class="space-y-3">
                              <label for="city" class="block text-base font-semibold text-gray-700 font-arabic">
                                   المدينة <span class="text-blue-500">*</span>
                              </label>
                              <div class="relative group">
                                   <select id="city" name="city" class="w-full h-12 pr-12 pl-4 bg-gray-50 border-2 border-gray-200 rounded-xl
                                   text-right font-arabic appearance-none
                                   focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10
                                   transition-all duration-300" required>
                                        <option value="" class="font-arabic">اختر مدينة</option>
                                        <% cities.forEach(city=> { %>
                                             <option value="<%= city.french %>" <%=user.location?.city===city.french ? 'selected' : '' %>
                                                  class="font-arabic py-2">
                                                  <%= city.arabic %>
                                             </option>
                                             <% }); %>
                                   </select>
                                   <i class="fas fa-map-marker-alt absolute right-4 top-1/2 -translate-y-1/2 text-gray-400
                             group-focus-within:text-blue-500 transition-colors"></i>
                                   <i class="fas fa-chevron-down absolute left-4 top-1/2 -translate-y-1/2 text-gray-400
                             group-focus-within:text-blue-500 transition-colors"></i>
                              </div>
                         </div>
                    </div>

                    <!-- Bio Section -->
                    <div class="space-y-3">
                         <label for="bio" class="block text-base font-semibold text-gray-700 font-arabic">
                              نبذة مهنية <span class="text-blue-500">*</span>
                         </label>
                         <div class="relative group">
                              <textarea id="bio" name="bio" rows="4" class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl
                                 text-right font-arabic resize-none
                                 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10
                                 transition-all duration-300" maxlength="500" required><%= user.bio %></textarea>
                              <div class="absolute left-3 bottom-3 px-2 py-1 text-sm font-medium text-blue-600 
                            bg-blue-50 rounded-lg border border-blue-100 font-arabic">
                                   <span id="bioLength">0</span>/500
                              </div>
                         </div>
                    </div>

                    <!-- Languages Section -->
                    <div class="space-y-4">
                         <label class="block text-base font-semibold text-gray-700 font-arabic">اللغات المتحدث بها</label>
                         <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                              <% const languageMap={ 'french' : 'الفرنسية' , 'arabic' : 'العربية' , 'english' : 'الإنجليزية' , 'spanish' : 'الإسبانية' } %>
                                   <% languageOptions.forEach(lang=> { %>
                                        <label class="relative flex items-center gap-3 p-3 bg-gray-50 rounded-xl 
                                 cursor-pointer group hover:bg-blue-50 transition-all duration-300">
                                             <input type="checkbox" id="lang-<%= lang %>" name="languages" value="<%= lang %>" <%=user.languages && user.languages.includes(lang) ? 'checked' : '' %>
                                             class="peer hidden">
                                             <span class="w-5 h-5 rounded border-2 border-gray-300 flex items-center justify-center
                                   peer-checked:border-blue-500 peer-checked:bg-blue-500 transition-all duration-300">
                                                  <i class="fas fa-check text-white scale-0 peer-checked:scale-100 transition-transform"></i>
                                             </span>
                                             <span class="font-arabic text-gray-700 peer-checked:text-blue-600 transition-colors">
                                                  <%= languageMap[lang] %>
                                             </span>
                                        </label>
                                        <% }); %>
                         </div>
                    </div>

                    <!-- Experience Section -->
                    <div class="space-y-4">
                         <label class="block text-base font-semibold text-gray-700 font-arabic">الخبرة</label>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                              <!-- Years -->
                              <div class="relative group">
                                   <label class="block text-sm font-medium text-gray-600 mb-2 font-arabic">سنوات الخبرة</label>
                                   <input type="number" name="experienceYears" id="experience-years" min="0" value="<%= user.experience?.years || 0 %>" class="w-full h-12 px-4 bg-gray-50 border-2 border-gray-200 rounded-xl
                                  text-right font-arabic
                                  focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10
                                  transition-all duration-300">
                              </div>
                              <!-- Description -->
                              <div class="relative group">
                                   <label class="block text-sm font-medium text-gray-600 mb-2 font-arabic">وصف الخبرة</label>
                                   <textarea name="experienceDescription" id="experience-description" rows="3" class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl
                                     text-right font-arabic resize-none
                                     focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10
                                     transition-all duration-300"><%= user.experience?.description || '' %></textarea>
                              </div>
                         </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4 pt-6 border-t">
                         <button type="button" id="cancelBasicInfoBtn" class="flex-1 h-12 bg-gray-50 text-gray-700 rounded-xl font-arabic
                           hover:bg-gray-100 focus:ring-4 focus:ring-gray-200
                           transition-all duration-300 group">
                              <i class="fas fa-times ml-2 group-hover:rotate-90 transition-transform"></i>
                              إلغاء
                         </button>
                         <button type="submit" class="flex-1 h-12 bg-blue-600 text-white rounded-xl font-arabic
                           hover:bg-blue-700 focus:ring-4 focus:ring-blue-500/30
                           transition-all duration-300 group">
                              <i class="fas fa-check ml-2 group-hover:scale-110 transition-transform"></i>
                              حفظ
                         </button>
                    </div>
               </form>
          </div>

          <!-- Keep the original script but add these styles -->
          <style>
               @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700&display=swap');

               .font-arabic {
                    font-family: 'Tajawal', sans-serif;
               }

               /* Enhanced focus states */
               .group:focus-within i {
                    transform: translateY(-50%) scale(1.1);
               }

               /* Smooth transitions */
               input,
               select,
               textarea {
                    transition: all 0.3s ease;
               }

               /* Custom checkbox styles */
               input[type="checkbox"] {
                    transition: all 0.2s ease;
               }

               /* Input hover effects */
               input:hover:not(:focus),
               select:hover:not(:focus),
               textarea:hover:not(:focus) {
                    background-color: #F8FAFC;
                    transform: translateY(-1px);
               }

               /* Button hover effects */
               button:hover {
                    transform: translateY(-1px);
               }

               button:active {
                    transform: translateY(1px);
               }

               /* Direction specific styles */
               .direction-ltr {
                    direction: ltr;
               }

               /* The rest of your original styles... */
          </style>
          <script>
               document.addEventListener('DOMContentLoaded', function () {
                    const $bioTextarea = document.getElementById('bio');
                    const $bioLength = document.getElementById('bioLength');

                    // Mise à jour du compteur de caractères de la bio
                    function updateBioLength() {
                         const length = $bioTextarea.value.length;
                         $bioLength.textContent = length;

                         // Retour visuel
                         if (length > 450) {
                              $bioLength.classList.add('text-orange-500');
                         } else if (length > 480) {
                              $bioLength.classList.add('text-red-500');
                         } else {
                              $bioLength.classList.remove('text-orange-500', 'text-red-500');
                         }
                    }

                    $bioTextarea?.addEventListener('input', updateBioLength);
                    updateBioLength();

                    // Gestion du bouton Annuler
                    const $cancelBtn = document.getElementById('cancelBasicInfoBtn');
                    $cancelBtn.addEventListener('click', () => {
                         // Recharge la page pour réinitialiser le formulaire
                         window.location.reload();
                    });

                    // Soumission du formulaire avec validation
                    const $editForm = document.getElementById('basicInfoForm');
                    $editForm.addEventListener('submit', async function (e) {
                         e.preventDefault();

                         const $submitBtn = this.querySelector('button[type="submit"]');
                         const $allInputs = this.querySelectorAll('input, select, textarea');

                         // Désactive tous les éléments du formulaire
                         $submitBtn.disabled = true;
                         $allInputs.forEach(input => input.disabled = true);

                         // Ajoute un état de chargement au bouton de soumission
                         $submitBtn.innerHTML = `
               <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                   <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                   <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
               </svg>
               Enregistrement...
               `;

                         try {
                              // Récupère les données du formulaire
                              const formData = new FormData(this);

                              // Construit les données à envoyer
                              const data = {
                                   displayName: document.getElementById('displayName').value,
                                   bio: document.getElementById('bio').value,
                                   phoneNumber: document.getElementById('phoneNumber').value,
                                   location: {
                                        city: document.getElementById('city').value
                                   },
                                   languages: Array.from(document.querySelectorAll('input[name="languages"]:checked')).map(el => el.value),
                                   experience: {
                                        years: parseInt(document.getElementById('experience-years').value, 10) || 0,
                                        description: document.getElementById('experience-description').value || 'Sans expérience.'
                                   }
                              };

                              // Envoie la requête avec l'état de chargement
                              const response = await fetch('/dashboard/profile/update-basic-info', {
                                   method: 'PUT',
                                   headers: { 'Content-Type': 'application/json' },
                                   body: JSON.stringify(data)
                              });

                              const result = await response.json();

                              if (response.ok) {
                                   // Affiche un message de succès avant de recharger
                                   Swal.fire({
                                        icon: 'success',
                                        title: 'Succès !',
                                        text: 'Vos informations ont été mises à jour avec succès',
                                        showConfirmButton: false,
                                        timer: 1500
                                   }).then(() => {
                                        window.location.reload();
                                   });
                              } else {
                                   throw new Error(result.message);
                              }
                         } catch (error) {
                              // Affiche un message d'erreur avec SweetAlert2
                              Swal.fire({
                                   icon: 'error',
                                   title: 'Erreur',
                                   text: error.message || 'Une erreur est survenue lors de la mise à jour',
                                   confirmButtonText: 'Réessayer',
                                   confirmButtonColor: '#3B82F6'
                              });

                              // Réinitialise l'état du bouton et du formulaire
                              $submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Enregistrer';
                              $submitBtn.disabled = false;
                              $allInputs.forEach(input => input.disabled = false);
                         }
                    });

                    // Validation et formatage du numéro de téléphone
                    const $phoneInput = document.getElementById('phoneNumber');
                    $phoneInput?.addEventListener('input', function (e) {
                         let value = e.target.value.replace(/\D/g, '');

                         if (value.startsWith('212')) {
                              value = '+' + value;
                         } else if (value.startsWith('0')) {
                              value = value;
                         } else if (value.length > 0) {
                              value = '0' + value;
                         }

                         e.target.value = value;
                    });

                    // Ajout des styles d'animation
                    const style = document.createElement('style');
                    style.textContent = `
          @keyframes fadeSlideIn {
               from {
                    opacity: 0;
                    transform: translateY(-10px);
               }
               to {
                    opacity: 1;
                    transform: translateY(0);
               }
          }

          .animate-fade-slide-in {
               animation: fadeSlideIn 0.3s ease-out forwards;
          }

          /* Styles personnalisés pour les cases à cocher */
          input[type="checkbox"] {
               transition: all 0.2s ease-in-out;
          }

          input[type="checkbox"]:checked + label {
               color: #1D4ED8;
          }

          /* Effets de focus pour les champs de saisie */
          input:focus, select:focus, textarea:focus {
               box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
          }
          `;
                    document.head.appendChild(style);
               });
          </script>